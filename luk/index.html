<script src="https://unpkg.com/kdbush@3.0.0/kdbush.min.js"></script>

<script>

    const getDistanceFromLatLonInKm = (() => {
        const deg2rad = function deg2rad(deg) {
            return deg * (Math.PI / 180)
        };

        return function (lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of the earth in km
            const dLat = deg2rad(lat2 - lat1);  // deg2rad below
            const dLon = deg2rad(lon2 - lon1);
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2)
            ;
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const d = R * c; // Distance in km
            return d * 1000;
        }
    })();

    const loadJson = filename => fetch(filename).then(response => response.json());

    const updLoc = function () {
        navigator.geolocation.getCurrentPosition((position => {
            document.getElementById('lat').value = position.coords.latitude;
            document.getElementById('lon').value = position.coords.longitude;
        }));
    };

    var data = {};
    var db;

    function getObjects(lat, lon, count) {
        let nearestpoints = [];
        let r = 0.18;
        while (nearestpoints.length < count) {
            r += 0.001;
            nearestpoints = db.within(lat, lon, r);
        }

        return [...new Set(nearestpoints.map(idx => data.ids[idx]))].map(id => data.objects[id]);
    }

    function isTitleMatch(title, reqs) {
        let ttl = title.toLowerCase();

        for (let i = 0; i < reqs.length; i++) {
            if (ttl.indexOf(reqs[i]) < 0) return false;
        }

        return true;
    }

    function isObjectMatch(obj, reqs) {
        try {
            for (let i = 0; i < obj.names.length; i++) {
                if (isTitleMatch(obj.names[i], reqs)) {
                    return i;
                }
            }
        } catch (e) {
        }
        return -1;
    }


    function search(string, lat, lon) {

        let objects = getObjects(lat, lon, 1000);

        let reqs = document.getElementById("search").value.toLowerCase().split(" ");

        let result = [];

        for (let i = 0; i < objects.length; i++) {
            let match = isObjectMatch(objects[i], reqs);
            if (match >= 0) {
                let coords = objects[i].coords;
                let minDistance = Infinity;
                let foundCoords = [0, 0];
                for (let j = 0; j < coords.length; j++) {
                    let dst = getDistanceFromLatLonInKm(coords[j][0], coords[j][1], lat, lon);
                    if (dst < minDistance) {
                        foundCoords = coords[j];
                        minDistance = dst;
                    }
                }
                result.push({
                    title: objects[i].names[match],
                    dist: minDistance,
                    allCoords: coords,
                    coords: foundCoords
                });
            }
        }

        result.sort((a, b) => a.dist - b.dist);
        return result.slice(0, 50);
    }


    function doSearch() {
        let searchResult = search(
            document.getElementById("search").value,
            parseFloat(document.getElementById("lat").value),
            parseFloat(document.getElementById("lon").value)
        );
        let res = document.getElementById("result");
        res.innerHTML = "";
        for (let i = 0; i < searchResult.length; i++) {
            const r = searchResult[i];
            const iDist = Math.round(r.dist);
            res.innerHTML +=
                (`<a target="_blank" href="https://www.google.com/maps/search/${r.coords[0]},${r.coords[1]}">` +
                    `<span class="title">${r.title}</span> – ${iDist} м.</a>`);
        }
    }

    function onLoad() {
        updLoc();
        setInterval(updLoc, 5000);

        Promise.all([
            loadJson('points.json')
                .then(x => data.points = x)
                .then(() => db = new KDBush(data.points)),
            loadJson('ids.json').then(x => data.ids = x),
            loadJson('objects.json').then(x => data.objects = x)])
            .then(() => document.getElementById('search').disabled = false);
    }
</script>


<head>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
          integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
    <title>nearest pois</title>
</head>
<style>
    body, input {
        background: black;
        color: #ddd;
    }

    input {
        border: solid 1px grey;
    }

    #result a {
        display: block;
        margin: 3px;
        color: #afd;
    }

    #result .coords {
        color: #ccc;
    }

    #status {
        position: fixed;
        bottom: 0;
        width: 100%;
    }

</style>

<meta name='viewport' content='initial-scale=1, viewport-fit=cover'>
<body onload="onLoad();">
<label for="lat">Lat:</label> <input id="lat" value="50.4491662"/><br/>
<label for="lon">Lon:</label> <input id="lon" value="30.5055493"/><br/>
<input id="search"
       onchange="doSearch();" onkeyup="doSearch();" disabled/>
<div id="result">

</div>
<div id="status"></div>
</body>
